# Uncomment these types if you want even more clean repository. But be careful.
# It can make harm to an existing project source. Read explanations below.
#
# Resource files are binaries containing manifest, project icon and version info.
# They can not be viewed as text or compared by diff-tools. Consider replacing them with .rc files.
#*.res
#
# Type library file (binary). In old Delphi versions it should be stored.
# Since Delphi 2009 it is produced from .ridl file and can safely be ignored.
#*.tlb
#
# Diagram Portfolio file. Used by the diagram editor up to Delphi 7.
# Uncomment this if you are not using diagrams or use newer Delphi version.
#*.ddp
#
# Visual LiveBindings file. Added in Delphi XE2.
# Uncomment this if you are not using LiveBindings Designer.
#*.vlb
#
# Deployment Manager configuration file for your project. Added in Delphi XE2.
# Uncomment this if it is not mobile development and you do not use remote debug feature.
#*.deployproj
#

# Delphi compiler-generated binaries (safe to delete)
*.exe
*.dll
*.bpl
*.bpi
*.dcp
*.so
*.apk
*.drc
*.map
*.dres
*.rsm
*.tds
*.dcu
*.lib

# Delphi autogenerated files (duplicated info)
*.cfg
*Resource.rc

# Delphi local files (user-specific info)
*.local
*.identcache
*.projdata
*.tvsconfig
*.dsk

# Delphi history and backups
__history/
*.~*

# Castalia statistics file
*.stat
unit ss3p;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, DB, DBTables, ExtCtrls, ADODB, ComCtrls, Grids;

type
  TForm1 = class(TForm)
    Label6: TLabel;
    Label7: TLabel;
    Button6: TButton;
    Query1: TQuery;
    ADOConnection1: TADOConnection;
    ADOTRfc: TADOTable;
    ADOTCel: TADOTable;
    ADOTMesCelCcl: TADOTable;
    ADOQuery1: TADOQuery;
    Label10: TLabel;
    Label11: TLabel;
    ADOQuery2: TADOQuery;
    Label1: TLabel;
    ADOTMesCelCcr: TADOTable;
    ADOTMesFlt: TADOTable;
    ADOTMesMde: TADOTable;
    ADOTMesSfl: TADOTable;
    ADOTMesT: TADOTable;
    ADOTMesTbf: TADOTable;
    Label2: TLabel;
    Edit1: TEdit;
    ProgressBar1: TProgressBar;
    StringGrid1: TStringGrid;
    Button1: TButton;
    Edit2: TEdit;
    Edit3: TEdit;
    Button2: TButton;
    Button3: TButton;
    Button4: TButton;
    Button5: TButton;
    Timer1: TTimer;
    RadioGroup1: TRadioGroup;
    Label3: TLabel;
    Button7: TButton;
    CheckBox1: TCheckBox;
    procedure FormShow(Sender: TObject);
    procedure Button6Click(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button5Click(Sender: TObject);
    procedure Button4Click(Sender: TObject);
    procedure Timer1Timer(Sender: TObject);
    procedure Button7Click(Sender: TObject);
    procedure CheckBox1Click(Sender: TObject);

  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form1: TForm1;
  a:array[1..7] of integer;

implementation

{$R *.dfm}

procedure TForm1.FormShow(Sender: TObject);
var
  i:integer;
begin
  a[7]:=STRTOINT(Edit1.text);   // StId                                          //2011.03.23 修正
  for i := 1 to 6 do a[i]:=0;
  if a[7]=3 then
    begin
      a[1]:=0;      // Mes.Id       //T3  2013.6.6 ACCESS寫入資料庫
      a[2]:=0;      // MesCel.Id
      a[3]:=0;      // MesRfc.Id
      a[4]:=0;      // MesMde.Id
      a[5]:=0;      // MesFlt.Id
      a[6]:=0;      // MesTbf.Id
    end;
  Button7.Click;                                                                 // check access sql
end;

procedure TForm1.Button6Click(Sender: TObject);
begin
//  ProgressBar1.Position:=50;
  Button3.click;
//  ProgressBar1.Position:=80;
//  Button4.click;
//  ProgressBar1.Position:=90;
//  Button5.click;
  ProgressBar1.Position:=0;
  Button7.click;
end;

procedure TForm1.Button1Click(Sender: TObject);
var
  id,i:integer;
  CSerN,RsMxp:STRING;
begin
  ProgressBar1.Position:=0;

  ADOQuery1.close;                                                                  //Mes
  ADOQuery1.SQL.Clear;
  ADOQuery1.SQL.add('select Mes.Id, MdeId, CelId, RfcId, FltId, TbfId, ResId, Mid, SerN, Nbm, Mes.Nfl, Stp, Spare, DtCr,MesRes.RsMxp');                    //找出 SQL server 最後ㄧ筆 Mes.ID
  ADOQuery1.sql.add('from Mes,MesRes');
  ADOQuery1.sql.add('Where Mes.Id >:Id1');
  ADOQuery1.sql.add('and Mes.StId=:StId');                                         // 2010.4.15 增加simulator Id
  ADOQuery1.sql.add('and Mes.StId=MesRes.StId');
  ADOQuery1.sql.add('and Mes.Id=MesRes.Id');
  ADOQuery1.sql.add('and Mes.OK=:ok');
  ADOQuery1.sql.add('order by Mes.Id');
  ADOQuery1.Parameters.parambyname('StId').VALUE:=a[7];
  ADOQuery1.Parameters.parambyname('Id1').VALUE:=a[1];
//  ADOQuery1.Parameters.parambyname('Id1').VALUE:=98874;
  ADOQuery1.Parameters.parambyname('ok').VALUE:=1;
  ADOQuery1.open;

  ProgressBar1.max:=ADOQuery1.recordcount;
  i:=0;
  if ADOQuery1.recordcount > 0 then
   begin
     while not ADOQuery1.EOF do
       begin
         RsMxp:=FloattoStr(ADOQuery1.Fields[14].value*100);                          // 生耀客戶序號
         CSerN:='26'+copy(ADOQuery1.Fields[8].value,4,4)+copy(ADOQuery1.Fields[8].value,10,2)+'0'+copy(ADOQuery1.Fields[8].value,14,3)+copy(RsMxp,1,5)+'X';

         Edit3.text:=CSerN;
         Edit2.text:=ADOQuery1.Fields[8].value;

         ADOQuery2.close;
         ADOQuery2.SQL.Clear;
         ADOQuery2.SQL.add('update Mes set CSerN=:CSerN');
         ADOQuery2.SQL.add('where Mes.Id=:Id');
         ADOQuery2.Parameters.ParamByName('Id').Value:=ADOQuery1.Fields[0].value;
         ADOQuery2.Parameters.ParamByName('CSerN').Value:=CSerN;                                // 2010.11.22 增加CSerN
//         ADOQuery2.ExecSQL;

         i:=i+1;
         ProgressBar1.Position:=i;
         ADOQuery1.next;
       end;
      showmessage('CSerN UPDATE ok')
    end;
end;

procedure TForm1.Button2Click(Sender: TObject);
begin
  ADOQuery2.close;
  ADOQuery2.SQL.Clear;
  ADOQuery2.SQL.add('update Mes set CSerN=:CSerN');
  ADOQuery2.SQL.add('where Mes.SerN=:SerN');
  ADOQuery2.SQL.add('and OK=:OK');
  ADOQuery2.Parameters.ParamByName('SerN').Value:=Edit2.text;
  ADOQuery2.Parameters.ParamByName('CSerN').Value:=Edit3.text;                                // 2010.11.26 手動更新CSerN
  ADOQuery2.Parameters.ParamByName('OK').Value:=1;
  ADOQuery2.ExecSQL;
end;

procedure TForm1.Button3Click(Sender: TObject);
var
  id,id2,i:integer;
  CSerN,RsMxp:STRING;
begin
  Label1.Caption:='db copying ........';

  ADOQuery1.close;                                                               //Mes
  ADOQuery1.SQL.Clear;
  ADOQuery1.SQL.add('select Id,DtCr');                                           //找出 SQL server 最後ㄧ筆 Mes.ID
  ADOQuery1.sql.add('from Mes');
  ADOQuery1.sql.add('Where Id >=:Id');
  ADOQuery1.sql.add('and StId=:StId');                                           // 2010.4.15 增加simulator Id
  ADOQuery1.sql.add('order by Id');
  ADOQuery1.Parameters.parambyname('StId').VALUE:=a[7];
  ADOQuery1.Parameters.parambyname('Id').VALUE:= a[1];
  ADOQuery1.open;
  ADOQuery1.last;
  id:=0;
  if ADOQuery1.RecordCount>0 then id:=ADOQuery1.Fields[0].value;
  ADOQuery1.close;

  ProgressBar1.Position:=10;

  query1.close;
  query1.SQL.Clear;                                                             //找出 access > sql 最後ㄧ筆 Mes.ID 的所有記錄
  query1.SQL.add('select Index, SN, Counter, Type, StopDate, StopTime, IrrCorr, TCorr, ModuleArea, CellArea, Isc, Voc, Rs, Rsh, PMax, Vpm, Ipm, Vld, Ivld, Pvld, FF, Eff, Op, Comment, Parameter, RefCal, IrrMeas, TMeas,HVoltTestCurrent,HResistTestResist');
  query1.sql.add('from Results');
  query1.sql.add('where Index >:id');
//  query1.sql.add('and Index <:id1');
  query1.sql.add('and IrrCorr >0');                                             // 2013.07.30 增加檢查 IrrCorr>0 排除未測資料
  query1.sql.add('order by Index');
  query1.parambyname('id').asinteger:=id;
//  query1.parambyname('id1').asinteger:=3;                                       // 2013.09.09 補上傳 counter >9999 <2
  query1.open;
  query1.first;

  ProgressBar1.max:=query1.recordcount;
  i:=1;

  if query1.recordcount > 0 then
    begin
      while not query1.EOF do
        begin
          ADOQuery2.close;
          ADOQuery2.SQL.Clear;
          ADOQuery2.SQL.add('update Mes set OK=0');                               //將已有相同序號資料 OK欄位歸0
          ADOQuery2.sql.add('Where SerN=:srn1');
          ADOQuery2.Parameters.parambyname('srn1').VALUE:= query1.Fields[1].value;
          ADOQuery2.ExecSQL;
          RsMxp:=FloattoStr(query1.Fields[14].value);
          CSerN:='';                                                              // 2010.11.22 增加CSerN 計算
          if RadioGroup1.ItemIndex= 1 then CSerN:='26'+copy(query1.Fields[8].value,4,4)+copy(query1.Fields[8].value,10,2)+'0'+copy(query1.Fields[8].value,14,3)+copy(RsMxp,1,3)+copy(RsMxp,5,2)+'X';    // 2010.11.22 增加CSerN
          if RadioGroup1.ItemIndex= 2 then CSerN:=Edit3.Text;
          ADOQuery2.close;
          ADOQuery2.SQL.Clear;
          ADOQuery2.SQL.add('insert into Mes (Id, MdeId, CelId, RfcId, FltId, TbfId, ResId, Mid, SerN, Nbm, Nfl, Stp, Spare, DtCr, OK, StId, CSerN)');
          ADOQuery2.sql.add('values (:Id, :MdeId, :CelId, :RfcId, :FltId, :TbfId, :ResId, :Mid, :SerN, :Nbm, :Nfl, :Stp, :Spare, :DtCr, :OK, :StId, :CSerN) ');
          ADOQuery2.Parameters.ParamByName('Id').Value:= query1.FieldByName('Index').value+a[1];             //2010.11.30 改成  ParamByName()
          ADOQuery2.Parameters.ParamByName('CelId').Value:= query1.FieldByName('Index').value+a[1];
          ADOQuery2.Parameters.ParamByName('SerN').Value:= query1.FieldByName('SN').value;
          ADOQuery2.Parameters.ParamByName('DtCr').Value:= query1.FieldByName('StopDate').asstring +' '+query1.FieldByName('StopTime').asstring;
          ADOQuery2.Parameters.ParamByName('OK').Value:=1;
          ADOQuery2.Parameters.ParamByName('StId').Value:=a[7];                 // 2010.4.15 增加simulator Id
          ADOQuery2.Parameters.ParamByName('CSerN').Value:=CSerN;               // 2010.11.22 增加CSerN
          ADOQuery2.ExecSQL;

//          Label1.Caption:='Mes copy ok!';

          ADOQuery2.close;
          ADOQuery2.SQL.Clear;
          ADOQuery2.SQL.add('insert into MesRes (Id,Cli,Irm,Idv,VocStd,IscStd,RsrStd,RshStd,VocVoc,RsrVoc,IscIsc,RshIsc,RsrRsr,RshRsh,Rsd,Nfl,RsVoc,RsIsc,RsUisc,RsMxp,RsMxe,RsEff,RsVpm,RsIpm,RsIav1,RsPav1,RsIav2,RsPav2,RsRsr,RsRsh,RsCcf,RsVcf,RsKcf,StId)');
          ADOQuery2.sql.add('values (:Id,:Cli,:Irm,:Idv,:VocStd,:IscStd,:RsrStd,:RshStd,:VocVoc,:RsrVoc,:IscIsc,:RshIsc,:RsrRsr,:RshRsh,:Rsd,:Nfl,:RsVoc,:RsIsc,:RsUisc,:RsMxp,:RsMxe,:RsEff,:RsVpm,:RsIpm,:RsIav1,:RsPav1,:RsIav2,:RsPav2,:RsRsr,:RsRsh,:RsCcf,:RsVcf,:RsKcf,:StId) ');
          ADOQuery2.Parameters.ParamByName('Id').Value:= query1.FieldByName('Index').value+a[1];        //2010.11.30 改成  FieldByName()
          ADOQuery2.Parameters.ParamByName('Irm').Value:= query1.FieldByName('IrrMeas').value;
          ADOQuery2.Parameters.ParamByName('RsVoc').Value:= query1.FieldByName('Voc').value;
          ADOQuery2.Parameters.ParamByName('RsIsc').Value:= query1.FieldByName('Isc').value;
          ADOQuery2.Parameters.ParamByName('RsMxp').Value:= query1.FieldByName('PMax').value;
          ADOQuery2.Parameters.ParamByName('RsMxe').Value:= query1.FieldByName('Eff').value/100;
          ADOQuery2.Parameters.ParamByName('RsEff').Value:= query1.FieldByName('FF').value;
          ADOQuery2.Parameters.ParamByName('RsVpm').Value:= query1.FieldByName('Vpm').value;
          ADOQuery2.Parameters.ParamByName('RsIpm').Value:= query1.FieldByName('Ipm').value;
          ADOQuery2.Parameters.ParamByName('RsRsr').Value:= query1.FieldByName('Rs').value;
          ADOQuery2.Parameters.ParamByName('RsRsh').Value:= query1.FieldByName('Rsh').value;
          ADOQuery2.Parameters.ParamByName('StId').Value:=a[7];                 // 2010.4.15 增加simulator Id
          ADOQuery2.ExecSQL;

//          Label1.Caption:='MesRes copy ok!';

          ADOQuery2.close;
          ADOQuery2.SQL.Clear;
          ADOQuery2.SQL.add('insert into MesT (MesId, MesTypId, T1, T4, StId)');
          ADOQuery2.sql.add('values (:MesId, :MesTypId, :T1, :T4, :StId) ');
          ADOQuery2.Parameters.ParamByName('MesId').Value:= query1.FieldByName('Index').value+a[1];             //2010.11.30 改成  FieldByName()
          ADOQuery2.Parameters.ParamByName('T1').Value:= query1.FieldByName('TCorr').value;
          ADOQuery2.Parameters.ParamByName('T4').Value:= query1.FieldByName('TMeas').value;
          ADOQuery2.Parameters.ParamByName('MesTypId').Value:=6;
          ADOQuery2.Parameters.ParamByName('StId').value:=a[7];                                                   // 2010.4.15 增加simulator Id
          ADOQuery2.ExecSQL;

//          Label1.Caption:='MesT copy ok!';

          ADOQuery2.close;
          ADOQuery2.SQL.Clear;
          ADOQuery2.SQL.add('insert into MesCel(Id,Dcel,CelT,MdId,Surf,Srfm,Ncs,Ncp,MaxV,MaxI,MinVs,MaxVs,MaxIs,V1Rsh,V2Rsh,ImxRsh,TcRsh,Vscm,DlTrg,T1,Ccf,Vcf,Kcf,Fcu,Fci,Fcp,RfIrr,Vrf1,Vrf2,Snmd,Fgm,PnTyp,RfPnl,StId)');
          ADOQuery2.sql.add('values(:Id,:Dcel,:CelT,:MdId,:Surf,:Srfm,:Ncs,:Ncp,:MaxV,:MaxI,:MinVs,:MaxVs,:MaxIs,:V1Rsh,:V2Rsh,:ImxRsh,:TcRsh,:Vscm,:DlTrg,:T1,:Ccf,:Vcf,:Kcf,:Fcu,:Fci,:Fcp,:RfIrr,:Vrf1,:Vrf2,:Snmd,:Fgm,:PnTyp,:RfPnl,:StId)');
          ADOQuery2.Parameters.ParamByName('Id').Value:=query1.FieldByName('Index').value+a[1];                // 2010.12.01 改用 FieldByName
          ADOQuery2.Parameters.ParamByName('CelT').value:=query1.FieldByName('Type').value;
          ADOQuery2.Parameters.ParamByName('Surf').value:=query1.FieldByName('CellArea').value;
          ADOQuery2.Parameters.ParamByName('Srfm').value:=query1.FieldByName('ModuleArea').value;
          ADOQuery2.Parameters.ParamByName('PnTyp').value:='False';
          ADOQuery2.Parameters.ParamByName('StId').value:=a[7];
          ADOQuery2.ExecSQL;

//          Label1.Caption:='MesCel copy ok!';

          ADOQuery2.close;                                                               // t3 hi-pot
          ADOQuery2.SQL.Clear;
          ADOQuery2.SQL.add('update SFCSNTJ');
          ADOQuery2.SQL.add('set OK=0');
          ADOQuery2.sql.add('WHERE SN=:SN');
          ADOQuery2.Parameters.ParamByName('SN').Value:= query1.FieldByName('SN').value;
          ADOQuery2.ExecSQL;

          ADOQuery2.close;
          ADOQuery2.SQL.Clear;
          ADOQuery2.SQL.add('insert into SFCSNTJ ( DT, WN, OK, SN, R1, R2, R3)');       // t3 hi-pot
          ADOQuery2.sql.add('values ( :DT, :WN, :OK, :SN, :R1, :R2, :R3) ');
          ADOQuery2.Parameters.ParamByName('DT').Value:= query1.FieldByName('StopDate').asstring +' '+query1.FieldByName('StopTime').asstring;
          ADOQuery2.Parameters.ParamByName('WN').Value:= a[7];
          ADOQuery2.Parameters.ParamByName('OK').Value:= 1;
          ADOQuery2.Parameters.ParamByName('SN').Value:= query1.FieldByName('SN').value;
          ADOQuery2.Parameters.ParamByName('R1').Value:= query1.FieldByName('HVoltTestCurrent').value*100000;
//          ADOQuery2.Parameters.ParamByName('R2').Value:= query1.FieldByName('HResistTestResist').value;
//          ADOQuery2.Parameters.ParamByName('R2').Value:= 3.6/(query1.FieldByName('HVoltTestCurrent').value*100000);    //20130924 增加 R2值
          ADOQuery2.Parameters.ParamByName('R3').Value:= 0;
          if query1.FieldByName('HVoltTestCurrent').value > 0 then                 // 20130828 跳過未測hipot 的標準片
            begin
              ADOQuery2.Parameters.ParamByName('R2').Value:= 3.6/(query1.FieldByName('HVoltTestCurrent').value*100000);    //20130925 增加 R2值
              ADOQuery2.ExecSQL;
            end;


//          Label1.Caption:='t3 hi-pot copy ok!';

          i:=i+1;
          ProgressBar1.Position:=i;

          query1.next;
        end;

    end;
    ADOQuery2.close;
    query1.close;
    Label1.Caption:='db copy ok!';
end;

procedure TForm1.Button5Click(Sender: TObject);
var
  id,i:integer;
begin

  Label1.Caption:='db copying ........';

  ADOQuery1.close;                                                               //MesResPts
  ADOQuery1.SQL.Clear;
  ADOQuery1.SQL.add('select MesId');
  ADOQuery1.sql.add('from MesResPts');
  ADOQuery1.sql.add('where Id=1');
  ADOQuery1.sql.add('and StId=:StId');                                           // 2010.4.15 增加simulator Id
  ADOQuery1.sql.add('and MesId>=:Id');
  ADOQuery1.sql.add('order by MesId');
  ADOQuery1.Parameters.parambyname('StId').VALUE:=a[7];
  ADOQuery1.Parameters.parambyname('Id').VALUE:= a[1];
  ADOQuery1.open;
  ADOQuery1.last;
  id:=0;
  if ADOQuery1.RecordCount>0 then id:=ADOQuery1.Fields[0].value;
  ADOQuery1.close;

  query1.close;
  query1.SQL.Clear;
  query1.SQL.add('select *');
  query1.sql.add('from MesResPts');
  query1.sql.add('where MesId >:id');
  query1.parambyname('id').asinteger:=id-a[1];
  query1.open;
  query1.first;
  ProgressBar1.Position:=0;
  ProgressBar1.Max:=query1.recordcount;

  if query1.recordcount > 0 then
    begin
      while not query1.EOF do
        begin
          ADOQuery2.close;
          ADOQuery2.SQL.Clear;
          ADOQuery2.SQL.add('insert into MesResPts (Id, MesId, SubMesId, Cv, Cc, Cp, StId)');
          ADOQuery2.sql.add('values (:Id, :MesId, :SubMesId, :Cv, :Cc, :Cp, :StId) ');
          ADOQuery2.Parameters.ParamByName('Id').Value:= query1.FieldByName('Id').value;       //2010.11.30 改成  ParamByName()
          ADOQuery2.Parameters.ParamByName('MesId').Value:= query1.FieldByName('MesId').value+a[1];
          ADOQuery2.Parameters.ParamByName('SubMesId').Value:= query1.FieldByName('SubMesId').value;
          ADOQuery2.Parameters.ParamByName('Cv').Value:= query1.FieldByName('Cv').value;       // V2.12 增加欄位
          ADOQuery2.Parameters.ParamByName('Cc').Value:= query1.FieldByName('Cc').value;
          ADOQuery2.Parameters.ParamByName('Cp').Value:= query1.FieldByName('Cp').value;
          ADOQuery2.Parameters.ParamByName('StId').Value:=a[7];
          ADOQuery2.ExecSQL;
          i:=i+1;
          ProgressBar1.Position:=i;
          query1.next;
        end;
//      showmessage('MesResPts copy ok')
    end;
    ProgressBar1.Position:=0;
    Label1.Caption:='db copy ok!';  
end;

procedure TForm1.Button4Click(Sender: TObject);
var
  id,i:integer;
begin

  Label1.Caption:='db copying ........';

  ADOQuery1.close;                                                                //MesCelCcl
  ADOQuery1.SQL.Clear;
  ADOQuery1.SQL.add('select CelId');
  ADOQuery1.sql.add('from MesCelCcl');
  ADOQuery1.sql.add('where StId=:StId');                                          // 2010.4.15 增加simulator Id
  ADOQuery1.sql.add('order by CelId');
  ADOQuery1.Parameters.parambyname('StId').VALUE:=a[7];
  ADOQuery1.open;
  ADOQuery1.last;
  id:=0;
  if ADOQuery1.RecordCount>0 then  id:=ADOQuery1.Fields[0].value;
  ADOQuery1.close;

  query1.close;
  query1.SQL.Clear;
  query1.SQL.add('select *');
  query1.sql.add('from MesCelCcl');
  query1.sql.add('where CelId >:id');
  query1.parambyname('id').asinteger:=id-a[2];
  query1.open;
  query1.first;

  if query1.recordcount > 0 then
    begin
      ADOTMesCelCcl.active:=true;
      ADOTMesCelCcl.last;
      while not query1.EOF do
        begin
          ADOTMesCelCcl.Append;
          ADOTMesCelCcl.FieldByName('Id').value:=query1.FieldByName('Id').value;          // 2010.12.01 改用 FieldByName
          ADOTMesCelCcl.FieldByName('CelId').value:=query1.FieldByName('CelId').value+a[2];
          ADOTMesCelCcl.FieldByName('Lbl').value:=query1.FieldByName('Lbl').value;
          ADOTMesCelCcl.FieldByName('ClTyp').value:=query1.FieldByName('ClTyp').value;
          ADOTMesCelCcl.FieldByName('ClOut').value:=query1.FieldByName('ClOut').value;
          ADOTMesCelCcl.FieldByName('StId').value:=a[7];
          query1.next;
        end;
      ADOTMesCelCcl.Post;
      ADOTMesCelCcl.active:=false;
//      showmessage('MesCelCcl copy ok')
    end;

  ProgressBar1.Position:=10;
  ADOQuery1.close;                                                                 //MesCelCcr
  ADOQuery1.SQL.Clear;
  ADOQuery1.SQL.add('select CelId');
  ADOQuery1.sql.add('from MesCelCcr');
  ADOQuery1.sql.add('where StId=:StId');                                          // 2010.4.15 增加simulator Id
  ADOQuery1.sql.add('order by CelId');
  ADOQuery1.Parameters.parambyname('StId').VALUE:=a[7];
  ADOQuery1.open;
  ADOQuery1.last;
  id:=0;
  if ADOQuery1.RecordCount>0 then id:=ADOQuery1.Fields[0].value;
  ADOQuery1.close;

  query1.close;
  query1.SQL.Clear;
  query1.SQL.add('select *');
  query1.sql.add('from MesCelCcr');
  query1.sql.add('where CelId >:id');
  query1.parambyname('id').asinteger:=id-a[2];
  query1.open;
  query1.first;

  if query1.recordcount > 0 then
    begin
      ADOTMesCelCcr.active:=true;
      ADOTMesCelCcr.last;
      while not query1.EOF do
        begin
          ADOTMesCelCcr.Append;
          ADOTMesCelCcr.FieldByName('Id').value:=query1.FieldByName('Id').value;          // 2010.12.01 改用 FieldByName
          ADOTMesCelCcr.FieldByName('CelId').value:=query1.FieldByName('CelId').value+a[2];
          ADOTMesCelCcr.FieldByName('CclId').value:=query1.FieldByName('CclId').value;
          ADOTMesCelCcr.FieldByName('FgOp').value:=query1.FieldByName('FgOp').value;
          ADOTMesCelCcr.FieldByName('Tgt1').value:=query1.FieldByName('Tgt1').value;
          ADOTMesCelCcr.FieldByName('Tgt2').value:=query1.FieldByName('Tgt2').value;
          ADOTMesCelCcr.FieldByName('StId').value:=a[7];
          query1.next;
        end;
      ADOTMesCelCcr.Post;
      ADOTMesCelCcr.active:=false;
//      showmessage('MesCelCcr copy ok')
    end;

  ProgressBar1.Position:=15;
  ADOQuery1.close;                                                                //MesRfc
  ADOQuery1.SQL.Clear;
  ADOQuery1.SQL.add('select Id');
  ADOQuery1.sql.add('from MesRfc');
  ADOQuery1.sql.add('where StId=:StId');                                          // 2010.4.15 增加simulator Id
  ADOQuery1.sql.add('order by Id');
  ADOQuery1.Parameters.parambyname('StId').VALUE:=a[7];
  ADOQuery1.open;
  ADOQuery1.last;
  id:=0;
  if ADOQuery1.RecordCount>0 then id:=ADOQuery1.Fields[0].value;
  ADOQuery1.close;

  query1.close;
  query1.SQL.Clear;
  query1.SQL.add('select *');
  query1.sql.add('from MesRfc');
  query1.sql.add('where Id >:id');
  query1.parambyname('id').asinteger:=id-a[3];
  query1.open;
  query1.first;

  if query1.recordcount > 0 then
    begin
      ADOTRfc.active:=true;
      ADOTRfc.last;
      while not query1.EOF do
        begin
          ADOTRfc.Append;
          ADOTRfc.FieldByName('Id').value:=query1.FieldByName('Id').value+a[3];          // 2010.12.01 改用 FieldByName
          ADOTRfc.FieldByName('Rct').value:=query1.FieldByName('Rct').value;
          ADOTRfc.FieldByName('Rcn').value:=query1.FieldByName('Rcn').value;
          ADOTRfc.FieldByName('Rcs').value:=query1.FieldByName('Rcs').value;
          ADOTRfc.FieldByName('Rvcf').value:=query1.FieldByName('Rvcf').value;
          ADOTRfc.FieldByName('Spare').value:=query1.FieldByName('Spare').value;
          ADOTRfc.FieldByName('DtCr').value:=query1.FieldByName('DtCr').value;
          ADOTRfc.FieldByName('DtMd').value:=query1.FieldByName('DtMd').value;
          ADOTRfc.FieldByName('Visa').value:=query1.FieldByName('Visa').value;
          ADOTRfc.FieldByName('StId').value:=a[7];
          query1.next;
        end;
      ADOTRfc.Post;
      ADOTRfc.active:=false;
//      showmessage('MesRfc copy ok')
    end;
  ProgressBar1.Position:=20;
  ADOQuery1.close;                                                                  //MesFlt
  ADOQuery1.SQL.Clear;
  ADOQuery1.SQL.add('select Id');
  ADOQuery1.sql.add('from MesFlt');
  ADOQuery1.sql.add('where StId=:StId');                                           // 2010.4.15 增加simulator Id
  ADOQuery1.sql.add('order by Id');
  ADOQuery1.Parameters.parambyname('StId').VALUE:=a[7];
  ADOQuery1.open;
  ADOQuery1.last;
  id:=0;
  if ADOQuery1.RecordCount>0 then   id:=ADOQuery1.Fields[0].value;
  ADOQuery1.close;

  query1.close;
  query1.SQL.Clear;
  query1.SQL.add('select *');
  query1.sql.add('from MesFlt');
  query1.sql.add('where Id >:id');
  query1.parambyname('id').asinteger:=id-a[5];
  query1.open;
  query1.first;

  if query1.recordcount > 0 then
    begin
      ADOTMesFlt.active:=true;
      ADOTMesFlt.last;
      while not query1.EOF do
        begin
          ADOTMesFlt.Append;
          ADOTMesFlt.FieldByName('Id').value:=query1.FieldByName('Id').value+a[5];          // 2010.12.01 改用 FieldByName
          ADOTMesFlt.FieldByName('Lbl').value:=query1.FieldByName('Lbl').value;
          ADOTMesFlt.FieldByName('Attn').value:=query1.FieldByName('Attn').value;
          ADOTMesFlt.FieldByName('Spare').value:=query1.FieldByName('Spare').value;
          ADOTMesFlt.FieldByName('DtCr').value:=query1.FieldByName('DtCr').value;
          ADOTMesFlt.FieldByName('DtMd').value:=query1.FieldByName('DtMd').value;
          ADOTMesFlt.FieldByName('Visa').value:=query1.FieldByName('Visa').value;
          ADOTMesFlt.FieldByName('StId').value:=a[7];
          query1.next;
        end;
      ADOTMesFlt.Post;
      ADOTMesFlt.active:=false;
//      showmessage('MesFlt copy ok')
    end;

  ProgressBar1.Position:=25;
  ADOQuery1.close;                                                                //MesMde
  ADOQuery1.SQL.Clear;
  ADOQuery1.SQL.add('select Id');
  ADOQuery1.sql.add('from MesMde');
  ADOQuery1.sql.add('where StId=:StId');                                         // 2010.4.15 增加simulator Id
  ADOQuery1.sql.add('order by Id');
  ADOQuery1.Parameters.parambyname('StId').VALUE:=a[7];
  ADOQuery1.open;
  ADOQuery1.last;
  id:=0;
  if ADOQuery1.RecordCount>0 then   id:=ADOQuery1.Fields[0].value;
  ADOQuery1.close;

  query1.close;
  query1.SQL.Clear;
  query1.SQL.add('select *');
  query1.sql.add('from MesMde');
  query1.sql.add('where Id >:id');
  query1.parambyname('id').asinteger:=id-a[4];
  query1.open;
  query1.first;

  if query1.recordcount > 0 then
    begin
      ADOTMesMde.active:=true;
      ADOTMesMde.last;
      while not query1.EOF do
        begin
          ADOTMesMde.Append;
          ADOTMesMde.FieldByName('Id').value:=query1.FieldByName('Id').value+a[4]; // 2010.12.01 改用 FieldByName
          ADOTMesMde.FieldByName('Nme').value:=query1.FieldByName('Nme').value;
          ADOTMesMde.FieldByName('Dsc').value:=query1.FieldByName('Dsc').value;
          ADOTMesMde.FieldByName('Emd').value:=query1.FieldByName('Emd').value;
          ADOTMesMde.FieldByName('Efg').value:=query1.FieldByName('Efg').value;
          ADOTMesMde.FieldByName('Stp').value:=query1.FieldByName('Stp').value;
          ADOTMesMde.FieldByName('Vms').value:=query1.FieldByName('Vms').value;
          ADOTMesMde.FieldByName('Vini').value:=query1.FieldByName('Vini').value;
          ADOTMesMde.FieldByName('Vter').value:=query1.FieldByName('Vter').value;
          ADOTMesMde.FieldByName('Vinc').value:=query1.FieldByName('Vinc').value;
          ADOTMesMde.FieldByName('Splt').value:=query1.FieldByName('Splt').value;
          ADOTMesMde.FieldByName('Tspc').value:=query1.FieldByName('Tspc').value;
          ADOTMesMde.FieldByName('Isr1').value:=query1.FieldByName('Isr1').value;
          ADOTMesMde.FieldByName('Isr2').value:=query1.FieldByName('Isr2').value;
          ADOTMesMde.FieldByName('T1').value:=query1.FieldByName('T1').value;
          ADOTMesMde.FieldByName('T2').value:=query1.FieldByName('T2').value;
          ADOTMesMde.FieldByName('T3').value:=query1.FieldByName('T3').value;
          ADOTMesMde.FieldByName('T4').value:=query1.FieldByName('T4').value;
          ADOTMesMde.FieldByName('DtCr').value:=query1.FieldByName('DtCr').value;
          ADOTMesMde.FieldByName('DtMd').value:=query1.FieldByName('DtMd').value;
          ADOTMesMde.FieldByName('Visa').value:=query1.FieldByName('Visa').value;
          ADOTMesMde.FieldByName('StId').value:=a[7];                            // 2010.4.15 增加simulator Id
          query1.next;
        end;
      ADOTMesMde.Post;
      ADOTMesMde.active:=false;
//      showmessage('MesMde copy ok')
    end;
{
  ADOQuery1.close;                               //MesSfl
  ADOQuery1.SQL.Clear;
  ADOQuery1.SQL.add('select Id');
  ADOQuery1.sql.add('from MesSfl');
  ADOQuery1.sql.add('order by Id');
  ADOQuery1.open;
  ADOQuery1.last;
  id:=ADOQuery1.Fields[0].value;
  ADOQuery1.close;

  query1.close;
  query1.SQL.Clear;
  query1.SQL.add('select *');
  query1.sql.add('from MesSfl');
  query1.sql.add('where Id >:id');
  query1.parambyname('id').asinteger:=id;
  query1.open;
  query1.first;

  if query1.recordcount > 0 then
    begin
      ADOTMesSfl.active:=true;
      ADOTMesSfl.last;
      while not query1.EOF do
        begin
          ADOTMesSfl.Append;
          ADOTMesSfl.Fields[0].value:=query1.Fields[0].value;
          for i := 1 to 3 do
            ADOTMesSfl.Fields[i].value:=query1.Fields[i].value;
          query1.next;
        end;
      ADOTMesSfl.Post;
      ADOTMesSfl.active:=false;
      showmessage('MesSfl copy ok')
    end;
}
   Label1.Caption:='db copy ok!';
end;

procedure TForm1.Timer1Timer(Sender: TObject);
var
  s:string;
begin
  s:=timetostr(now);
  if (copy(s,1,5)='00:30') or (copy(s,1,5)='03:30') or (copy(s,1,5)='05:30') or      //定時上傳資料
     (copy(s,1,5)='08:30') or (copy(s,1,5)='10:30') or (copy(s,1,5)='12:30') or
     (copy(s,1,5)='15:30') or (copy(s,1,5)='17:30') or (copy(s,1,5)='20:30') or
     (copy(s,1,5)='22:30') then
    begin
      Button6.Click;
    end;
end;

procedure TForm1.Button7Click(Sender: TObject);
begin
  query1.close;                                                                  // check access Mes 最後一筆資料日期
  query1.SQL.Clear;
  query1.SQL.add('select Index, StopDate, StopTime');
  query1.sql.add('from Results');
  query1.sql.add('where Index>:id');
  query1.sql.add('order by Index');
  query1.parambyname('id').asinteger:=1;
  query1.open;
  query1.last;
  Label7.Caption:=query1.Fields[1].asstring+' '+query1.Fields[2].asstring;

  ADOQuery1.close;                                                               //   check SQL Mes 最後一筆資料日期
  ADOQuery1.SQL.Clear;                                                           //   check SQL Mes.Id
  ADOQuery1.SQL.add('select DtCr,Id');
  ADOQuery1.sql.add('from Mes');
  ADOQuery1.sql.add('where StId=:StId');                                         // 2010.4.15 增加simulator Id
  ADOQuery1.sql.add('and Id>=:Id');
  ADOQuery1.sql.add('order by Id');
  ADOQuery1.Parameters.parambyname('StId').VALUE:=a[7];
  ADOQuery1.Parameters.parambyname('Id').VALUE:=a[1];
  ADOQuery1.open;
  ADOQuery1.last;
  Label11.Caption:=ADOQuery1.Fields[0].asstring;
  StringGrid1.Cells[1,1]:=ADOQuery1.Fields[1].asstring;

  ADOQuery1.close;
  ADOQuery1.SQL.Clear;                                                           // 2 check  MesCel 最後一筆Id
  ADOQuery1.SQL.add('select Id');
  ADOQuery1.sql.add('from MesCel');
  ADOQuery1.sql.add('where StId=:StId');
  ADOQuery1.sql.add('and Id>=:Id');
  ADOQuery1.sql.add('order by Id');
  ADOQuery1.Parameters.parambyname('StId').VALUE:=a[7];
  ADOQuery1.Parameters.parambyname('Id').VALUE:=a[2];
  ADOQuery1.open;
  ADOQuery1.last;
  StringGrid1.Cells[1,2]:=ADOQuery1.Fields[0].asstring;
  ADOQuery1.close;
  
  StringGrid1.Cells[0,1]:='Mes.Id';
  StringGrid1.Cells[0,2]:='MesCel.Id';
//  StringGrid1.Cells[0,3]:='MesRfc.Id';
//  StringGrid1.Cells[0,4]:='MesMde.Id';
//  StringGrid1.Cells[0,5]:='MesFlt.Id';
//  StringGrid1.Cells[0,6]:='MesTbf.Id';
  StringGrid1.Cells[1,0]:=Edit1.text;

end;

procedure TForm1.CheckBox1Click(Sender: TObject);
begin
   if CheckBox1.checked=true then Timer1.enabled:=true;
   if CheckBox1.checked=false then Timer1.enabled:=false;
end;

end.
